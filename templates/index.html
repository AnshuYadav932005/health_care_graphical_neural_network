<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare Fraud Detection</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- ───────── HEADER ───────── -->
    <header>
        <div class="header-inner">
            <div class="logo">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                <h1>Healthcare Fraud Detection</h1>
            </div>
            <p class="tagline">GNN-powered anomaly detection for Medicare provider data</p>
        </div>
    </header>

    <main>
        <!-- ───────── UPLOAD PANEL ───────── -->
        <section class="card upload-card" id="upload-section">
            <h2><span class="step-badge">1</span> Upload Provider Data</h2>
            <p class="hint">Upload your <strong>Healthcare Providers CSV</strong> file to begin the analysis.</p>

            <form id="upload-form" enctype="multipart/form-data">
                <div class="drop-zone" id="drop-zone">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="1.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    <p>Drag &amp; drop CSV here or <label class="file-btn" for="file-input">browse</label></p>
                    <input type="file" id="file-input" name="file" accept=".csv" hidden>
                    <span class="file-name" id="file-name"></span>
                </div>

                <div class="controls-row">
                    <div class="control-group">
                        <label for="n-top">Top Anomalies to Display</label>
                        <div class="range-wrap">
                            <input type="range" id="n-top" name="n_top" min="1" max="50" value="5">
                            <output id="n-top-val">5</output>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" id="run-btn" disabled>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                        Run Analysis
                    </button>
                </div>
            </form>
        </section>

        <!-- ───────── LOADING OVERLAY ───────── -->
        <div class="loading-overlay" id="loading" style="display:none;">
            <div class="spinner"></div>
            <p>Running GNN analysis… this may take a minute.</p>
        </div>

        <!-- ───────── RESULTS (hidden until analysis completes) ───────── -->
        <div id="results" style="display:none;">

            <!-- Summary cards -->
            <section class="summary-row">
                <div class="stat-card">
                    <span class="stat-value" id="stat-total">-</span>
                    <span class="stat-label">Providers Analyzed</span>
                </div>
                <div class="stat-card warn">
                    <span class="stat-value" id="stat-above">-</span>
                    <span class="stat-label">Flagged Suspicious</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="stat-threshold">-</span>
                    <span class="stat-label">Anomaly Threshold</span>
                </div>
            </section>

            <!-- Tab navigation -->
            <nav class="tabs">
                <button class="tab active" data-tab="tab-anomalies">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    Top Anomalies
                </button>
                <button class="tab" data-tab="tab-comparison">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                    Normal vs Suspicious
                </button>
                <button class="tab" data-tab="tab-distribution">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
                    Score Distribution
                </button>
                <button class="tab" data-tab="tab-network">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
                    Network Graph
                </button>
                <button class="tab" data-tab="tab-loss">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                    Training Loss
                </button>
            </nav>

            <!-- Tab panels -->
            <section class="tab-panel active" id="tab-anomalies">
                <div class="card">
                    <h3>Top <span id="n-label">5</span> Suspicious Providers</h3>
                    <p class="hint">Providers with the highest reconstruction error — their billing patterns deviate most from peers.</p>
                    <div class="table-wrap" id="anomaly-table"></div>
                </div>
            </section>

            <section class="tab-panel" id="tab-comparison">
                <div class="card">
                    <h3>Normal vs. Top Suspicious Provider</h3>
                    <p class="hint">Side-by-side comparison showing how the most anomalous provider deviates from the average.</p>
                    <div class="table-wrap" id="comparison-table"></div>
                </div>
            </section>

            <section class="tab-panel" id="tab-distribution">
                <div class="card">
                    <h3>Anomaly Score Distribution</h3>
                    <p class="hint">Histogram of reconstruction errors — the red dashed line is the statistical threshold (μ + 2σ).</p>
                    <img id="dist-img" class="chart-img" alt="anomaly score distribution">
                </div>
            </section>

            <section class="tab-panel" id="tab-network">
                <div class="card">
                    <h3>Provider Similarity Network</h3>
                    <p class="hint">Red nodes = flagged anomalies, blue nodes = normal neighbors. Each edge = similar billing pattern (KNN).</p>
                    <img id="net-img" class="chart-img" alt="provider network graph">
                </div>
            </section>

            <section class="tab-panel" id="tab-loss">
                <div class="card">
                    <h3>Model Training Loss</h3>
                    <p class="hint">Reconstruction error over training epochs — a decreasing curve indicates the model learned normal patterns.</p>
                    <img id="loss-img" class="chart-img" alt="training loss graph">
                </div>
            </section>
        </div>
    </main>

    <footer>
        <p>Healthcare Fraud Detection &mdash; Powered by Graph Neural Networks (PyTorch Geometric)</p>
    </footer>

    <!-- ───────── SCRIPT ───────── -->
    <script>
        const fileInput  = document.getElementById('file-input');
        const dropZone   = document.getElementById('drop-zone');
        const fileName   = document.getElementById('file-name');
        const runBtn     = document.getElementById('run-btn');
        const slider     = document.getElementById('n-top');
        const sliderVal  = document.getElementById('n-top-val');
        const loading    = document.getElementById('loading');
        const results    = document.getElementById('results');
        const form       = document.getElementById('upload-form');

        // -- Slider sync --
        slider.addEventListener('input', () => sliderVal.textContent = slider.value);

        // -- File selection --
        function handleFile(file) {
            if (file && file.name.endsWith('.csv')) {
                fileName.textContent = file.name;
                runBtn.disabled = false;
                dropZone.classList.add('has-file');
            }
        }
        fileInput.addEventListener('change', () => handleFile(fileInput.files[0]));

        // -- Drag & drop --
        dropZone.addEventListener('dragover',  e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFile(e.dataTransfer.files[0]);
            }
        });

        // -- Tab switching --
        document.querySelectorAll('.tab').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });

        // -- Form submit --
        form.addEventListener('submit', async e => {
            e.preventDefault();
            const fd = new FormData(form);
            // use the file from drop zone if selected
            if (fileInput.files[0]) fd.set('file', fileInput.files[0]);

            loading.style.display = 'flex';
            results.style.display = 'none';
            runBtn.disabled = true;

            try {
                const resp = await fetch('/analyze', { method: 'POST', body: fd });
                const data = await resp.json();
                if (data.error) { alert('Error: ' + data.error); return; }

                // Populate results
                document.getElementById('stat-total').textContent     = data.n_total.toLocaleString();
                document.getElementById('stat-above').textContent     = data.n_above.toLocaleString();
                document.getElementById('stat-threshold').textContent = data.threshold;
                document.getElementById('n-label').textContent        = data.n_top;
                document.getElementById('anomaly-table').innerHTML    = data.top_n_html;
                document.getElementById('comparison-table').innerHTML = data.comp_html;
                document.getElementById('dist-img').src               = 'data:image/png;base64,' + data.dist_img;
                document.getElementById('net-img').src                = 'data:image/png;base64,' + data.net_img;
                document.getElementById('loss-img').src               = 'data:image/png;base64,' + data.loss_img;

                results.style.display = 'block';
                results.scrollIntoView({ behavior: 'smooth' });
            } catch (err) {
                alert('Request failed: ' + err.message);
            } finally {
                loading.style.display = 'none';
                runBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
